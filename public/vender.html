<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gomer√≠a - Ventas</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
        .btn-cobrar { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        .total { font-size: 1.5em; font-weight: bold; color: #28a745; text-align: right; }
    </style>
</head>
<body>
    <div class="card">
        <h1>‚öíÔ∏è Terminal de Ventas</h1>
        <table>
            <thead><tr><th>Art√≠culo</th><th>Precio</th><th>Stock</th><th>Acci√≥n</th></tr></thead>
            <tbody id="tablaVentas"></tbody>
        </table>
    </div>

    <div class="card">
        <h2>üí∞ Cierre de Caja (Hoy)</h2>
        <table>
            <thead><tr><th>Hora</th><th>Descripci√≥n</th><th>Monto</th></tr></thead>
            <tbody id="tablaCierre"></tbody>
        </table>
        <div class="total" id="totalRendir">Total: $0</div>
    </div>

    <script>
        async function cargarTodo() { 
            await cargarProductos(); 
            await cargarCierre(); 
        }

        async function cargarProductos() {
            const res = await fetch('/productos');
            const productos = await res.json();
            const tabla = document.getElementById('tablaVentas');
            tabla.innerHTML = '';
            productos.forEach(p => {
                tabla.innerHTML += `<tr>
                    <td>${p.nombre}</td>
                    <td>$${p.precio_venta}</td>
                    <td>${p.categoria === 'Servicio' ? '‚àû' : p.stock_actual}</td>
                    <td><button class="btn-cobrar" onclick="vender(${p.id_producto}, '${p.nombre}')">COBRAR</button></td>
                </tr>`;
            });
        }

        async function cargarCierre() {
            const res = await fetch('/movimientos/hoy');
            const movs = await res.json();
            const tabla = document.getElementById('tablaCierre');
            let total = 0;
            tabla.innerHTML = '';
            movs.forEach(m => {
                total += parseFloat(m.monto_operacion);
                tabla.innerHTML += `<tr>
                    <td>${new Date(m.fecha).toLocaleTimeString()}</td>
                    <td>${m.descripcion}</td>
                    <td>$${m.monto_operacion}</td>
                </tr>`;
            });
            document.getElementById('totalRendir').innerText = `Total: $${total}`;
        }

        async function vender(id, nombre) {
            if (!confirm(`¬øCobrar ${nombre}?`)) return;
            try {
                const res = await fetch(`/productos/vender/${id}`, { method: 'PUT' });
                if (res.ok) {
                    alert("¬°Venta exitosa!");
                    cargarTodo();
                } else {
                    alert("Error en el servidor");
                }
            } catch (err) {
                alert("Error de conexi√≥n");
            }
        }

        window.onload = cargarTodo;
    </script>
</body>
</html>
