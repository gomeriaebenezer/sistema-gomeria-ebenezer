<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gomer√≠a - Terminal de Ventas</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1, h2 { text-align: center; color: #2c3e50; }
        .search-box { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ddd; font-size: 16px; margin-bottom: 20px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { color: #27ae60; }
        .btn-cobrar { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-cobrar:hover { background: #219150; }
        .total-caja { text-align: right; font-size: 1.5em; font-weight: bold; color: #27ae60; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h1>‚öíÔ∏è Terminal de Ventas</h1>
        <input type="text" id="buscador" class="search-box" placeholder="üîç Buscar producto por nombre..." onkeyup="filtrarProductos()">
        <table>
            <thead>
                <tr>
                    <th>Art√≠culo</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody id="listaProductos">
                </tbody>
        </table>
    </div>

    <div class="card">
        <h2>üí∞ Cierre de Caja (Hoy)</h2>
        <table>
            <thead>
                <tr>
                    <th>Hora</th>
                    <th>Descripci√≥n</th>
                    <th>Monto</th>
                </tr>
            </thead>
            <tbody id="listaMovimientos">
                </tbody>
        </table>
        <div class="total-caja">Total: $<span id="totalDia">0</span></div>
    </div>
</div>

<script>
    let productosRaw = [];

    // 1. Cargar productos desde el servidor
    async function cargarProductos() {
        try {
            const res = await fetch('/productos');
            productosRaw = await res.json();
            renderizarProductos(productosRaw);
        } catch (err) {
            console.error("Error al cargar productos:", err);
        }
    }

    function renderizarProductos(lista) {
        const tabla = document.getElementById('listaProductos');
        tabla.innerHTML = '';
        lista.forEach(p => {
            const stockDisplay = p.categoria === 'Servicio' ? '‚àû' : p.stock_actual;
            tabla.innerHTML += `
                <tr>
                    <td><strong>${p.nombre}</strong><br><small>${p.categoria}</small></td>
                    <td>$${p.precio_venta}</td>
                    <td>${stockDisplay}</td>
                    <td><button class="btn-cobrar" onclick="vender(${p.id_producto}, '${p.nombre}', ${p.precio_venta}, ${p.precio_costo}, '${p.categoria}')">COBRAR</button></td>
                </tr>
            `;
        });
    }

    // 2. Filtrar productos en tiempo real
    function filtrarProductos() {
        const busqueda = document.getElementById('buscador').value.toLowerCase();
        const filtrados = productosRaw.filter(p => p.nombre.toLowerCase().includes(busqueda));
        renderizarProductos(filtrados);
    }

    // 3. Procesar la venta
    async function vender(id, nombre, venta, costo, cat) {
        const ganancia = venta - costo;
        const datoVenta = {
            id_producto: id,
            cantidad: 1,
            monto_operacion: venta,
            ganancia_operacion: ganancia,
            descripcion: `Venta: ${nombre} (${cat})`
        };

        try {
            const res = await fetch('/vender', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datoVenta)
            });

            if (res.ok) {
                alert("‚úÖ Venta registrada");
                cargarProductos(); // Recarga stock
                cargarCaja();      // Recarga tabla de abajo
            } else {
                alert("‚ùå Error al registrar venta");
            }
        } catch (err) {
            console.error("Error en la venta:", err);
        }
    }

    // 4. Cargar movimientos del d√≠a para la caja
    async function cargarCaja() {
        try {
            const res = await fetch('/movimientos/todo');
            const movimientos = await res.json();
            
            const hoy = new Date().toISOString().split('T')[0];
            const tabla = document.getElementById('listaMovimientos');
            const totalDia = document.getElementById('totalDia');
            
            tabla.innerHTML = '';
            let total = 0;

            // Filtrar solo los de hoy
            const hoyMovs = movimientos.filter(m => m.fecha.startsWith(hoy));

            hoyMovs.forEach(m => {
                total += parseFloat(m.monto_operacion);
                const hora = new Date(m.fecha).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
                tabla.innerHTML += `
                    <tr>
                        <td>${hora}</td>
                        <td>${m.descripcion}</td>
                        <td>$${m.monto_operacion}</td>
                    </tr>
                `;
            });

            totalDia.innerText = total.toFixed(0);
        } catch (err) {
            console.error("Error al cargar caja:", err);
        }
    }

    // Al cargar la p√°gina
    window.onload = () => {
        cargarProductos();
        cargarCaja();
    };
</script>

</body>
</html>
