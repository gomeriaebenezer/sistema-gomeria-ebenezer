<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gomer√≠a - Admin Due√±o</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: url('fondo_admin.jpg') no-repeat center center fixed; 
            background-size: cover;
            padding: 10px; margin: 0; color: #333;
        }
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4); z-index: -1;
        }
        .container { max-width: 1200px; margin: auto; }
        .card { 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); 
            padding: 15px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); 
            margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.3);
        }
        h2 { color: #1a73e8; margin-top: 0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; align-items: end; }
        button { cursor: pointer; border: none; border-radius: 5px; font-weight: bold; padding: 12px; transition: 0.3s; }
        button:hover { opacity: 0.8; transform: translateY(-2px); }
        .btn-filtro { background: #6c757d; color: white; margin-right: 5px; padding: 8px 15px; }
        .btn-filtro.active { background: #1a73e8; }
        .btn-descargar { background: #28a745; color: white; margin-top: 10px; width: 100%; }
        .table-wrapper { overflow-x: auto; background: white; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; color: #1a73e8; }
        .total-box { display: flex; justify-content: flex-end; gap: 20px; margin-top: 15px; border-top: 2px solid #eee; padding-top: 10px; }
        .dashboard-main { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        .rango-fechas { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; align-items: center; }
        input, select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
        .low-stock { background: #fff2f2 !important; color: #dc3545; font-weight: bold; }
        .btn-delete { background: #dc3545; color: white; padding: 8px; margin-left: 5px; }
        .btn-edit { background: #ffc107; padding: 8px; }
    </style>
</head>
<body style="display: none;" id="contenidoProtegido">
<div class="container">
    <div class="card no-print">
        <h2 id="tituloForm">üì• Registro / Entrada de Mercader√≠a</h2>
        <form id="formProducto" class="form-grid">
            <div><label>Nombre del Producto</label><input type="text" id="nombre" required style="width:100%; box-sizing:border-box;"></div>
            <div><label>Categor√≠a</label>
                <select id="categoria" style="width:100%;">
                    <option value="Parches">Parches</option>
                    <option value="C√°maras">C√°maras</option>
                    <option value="Cubiertas">Cubiertas</option>
                    <option value="Servicio">Servicio</option>
                    <option value="Otros">Otros</option>
                </select>
            </div>
            <div><label>Costo ($)</label><input type="number" id="precio_costo" required style="width:100%;"></div>
            <div><label>Venta ($)</label><input type="number" id="precio_venta" required style="width:100%;"></div>
            <div><label>Cantidad/Stock</label><input type="number" id="stock_actual" required style="width:100%;"></div>
            <button type="submit" id="btnGuardar" style="background:#1a73e8; color:white;">GUARDAR / SUMAR</button>
        </form>
    </div>

    <div class="dashboard-main">
        <div class="card">
            <h2>üìä Reporte de Movimientos</h2>
            <div class="no-print">
                <button class="btn-filtro active" onclick="cargarMovimientos('hoy')">Hoy</button>
                <button class="btn-filtro" onclick="cargarMovimientos('semana')">Semana</button>
                <button class="btn-filtro" onclick="cargarMovimientos('mes')">Mes</button>
                <div class="rango-fechas">
                    <div>Desde: <input type="date" id="fechaDesde"></div>
                    <div>Hasta: <input type="date" id="fechaHasta"></div>
                    <button onclick="cargarMovimientos('rango')" style="background:#343a40; color:white; padding:8px 12px;">üîç Filtrar</button>
                </div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead><tr><th>Fecha/Hora</th><th>Descripci√≥n</th><th>Monto</th></tr></thead>
                    <tbody id="tablaMovimientos"></tbody>
                </table>
            </div>
            <div class="total-box">
                <div style="text-align: right;"><small>Facturaci√≥n:</small><br><strong id="totalVentas">$0</strong></div>
                <div style="text-align: right;"><small>Ganancia:</small><br><strong id="totalGanancia" style="color:#1e7e34; font-size:1.3em;">$0</strong></div>
            </div>
        </div>
        <div class="card">
            <h2 style="text-align: center;">üí∞ Por Rubro</h2>
            <div style="height: 250px;"><canvas id="graficoGanancia"></canvas></div>
            <button class="btn-descargar" onclick="descargarExcel()">üì• Descargar Excel</button>
        </div>
    </div>

    <div class="card no-print">
        <h2>üìã Inventario (B√∫squeda por Nombre o C√≥digo)</h2>
        <input type="text" id="buscador" placeholder="üîç Escriba c√≥digo # o nombre del producto..." onkeyup="buscar()" style="width:100%; padding:12px; margin-bottom:10px;">
        <div class="table-wrapper">
            <table>
                <thead><tr><th>C√≥d.</th><th>Art√≠culo</th><th>Cat.</th><th>Costo</th><th>Venta</th><th>Stock</th><th>Acciones</th></tr></thead>
                <tbody id="tablaCuerpo"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const pass = prompt("Ingrese clave:");
    if (pass === "ebenezer159.") {
        document.getElementById('contenidoProtegido').style.display = "block";
    } else {
        alert("Acceso denegado");
        window.location.href = "vender.html";
    }

    let editandoId = null; let chartInstance = null; let movimientosActuales = [];

    async function cargarStock() {
        const res = await fetch('/productos');
        const productos = await res.json();
        const tabla = document.getElementById('tablaCuerpo');
        tabla.innerHTML = '';
        productos.forEach(p => {
            const isServ = p.categoria === 'Servicio';
            const sClass = (!isServ && p.stock_actual < 3) ? 'low-stock' : '';
            const pString = JSON.stringify(p).replace(/"/g, '&quot;');
            tabla.innerHTML += `<tr class="${sClass}">
                <td><strong>#${p.id_producto}</strong></td>
                <td>${p.nombre}</td>
                <td>${p.categoria}</td>
                <td>$${p.precio_costo}</td>
                <td>$${p.precio_venta}</td>
                <td>${isServ ? '‚àû' : p.stock_actual}</td>
                <td>
                    <button class="btn-edit" onclick="prepararEdicion(${pString})">‚úèÔ∏è</button>
                    <button class="btn-delete" onclick="borrarProducto(${p.id_producto})">üóëÔ∏è</button>
                </td>
            </tr>`;
        });
    }

    async function borrarProducto(id) {
        if (!confirm("¬øEliminar este producto permanentemente?")) return;
        await fetch(`/productos/${id}`, { method: 'DELETE' });
        cargarStock();
    }

    async function cargarMovimientos(filtro) {
        let url = `/movimientos/${filtro}`;
        if (filtro === 'rango') {
            const desde = document.getElementById('fechaDesde').value;
            const hasta = document.getElementById('fechaHasta').value;
            url = `/movimientos/rango?desde=${desde}&hasta=${hasta}`;
        }
        const res = await fetch(url);
        const movs = await res.json();
        movimientosActuales = movs;
        const tabla = document.getElementById('tablaMovimientos');
        let totalV = 0, totalG = 0, cats = {};
        tabla.innerHTML = '';
        movs.forEach(m => {
            if(m.tipo_movimiento === 'VENTA') {
                totalV += parseFloat(m.monto_operacion);
                totalG += parseFloat(m.ganancia_operacion || 0);
                let c = m.descripcion.includes("Servicio") ? "Servicios" : "Productos";
                cats[c] = (cats[c] || 0) + parseFloat(m.ganancia_operacion || 0);
                tabla.innerHTML += `<tr><td>${new Date(m.fecha).toLocaleString('es-AR')}</td><td>${m.descripcion}</td><td>$${parseFloat(m.monto_operacion).toFixed(0)}</td></tr>`;
            }
        });
        document.getElementById('totalVentas').innerText = `$${totalV.toFixed(0)}`;
        document.getElementById('totalGanancia').innerText = `$${totalG.toFixed(0)}`;
        actualizarGrafico(cats);
    }

    function actualizarGrafico(datos) {
        const ctx = document.getElementById('graficoGanancia').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: Object.keys(datos), datasets: [{ data: Object.values(datos), backgroundColor: ['#1a73e8', '#28a745'] }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    document.getElementById('formProducto').addEventListener('submit', async (e) => {
        e.preventDefault();
        const datos = {
            nombre: document.getElementById('nombre').value,
            categoria: document.getElementById('categoria').value,
            precio_costo: document.getElementById('precio_costo').value,
            precio_venta: document.getElementById('precio_venta').value,
            stock_actual: document.getElementById('stock_actual').value
        };
        const url = editandoId ? `/productos/${editandoId}` : '/productos';
        const method = editandoId ? 'PUT' : 'POST';
        
        await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(datos) });
        
        editandoId = null;
        document.getElementById('formProducto').reset();
        document.getElementById('tituloForm').innerText = "üì• Registro / Entrada de Mercader√≠a";
        cargarStock(); cargarMovimientos('hoy');
    });

    function prepararEdicion(p) {
        editandoId = p.id_producto;
        document.getElementById('nombre').value = p.nombre;
        document.getElementById('categoria').value = p.categoria;
        document.getElementById('precio_costo').value = p.precio_costo;
        document.getElementById('precio_venta').value = p.precio_venta;
        document.getElementById('stock_actual').value = p.stock_actual;
        document.getElementById('tituloForm').innerText = "‚úèÔ∏è Editando: " + p.nombre;
        window.scrollTo(0,0);
    }

    function buscar() {
        const b = document.getElementById('buscador').value.toLowerCase();
        const filas = document.getElementById('tablaCuerpo').getElementsByTagName('tr');
        for (let f of filas) { f.style.display = f.innerText.toLowerCase().includes(b) ? '' : 'none'; }
    }

    function descargarExcel() {
        let csv = "Fecha;Descripcion;Monto;Ganancia\n";
        movimientosActuales.forEach(m => { csv += `${new Date(m.fecha).toLocaleString()};${m.descripcion};${m.monto_operacion};${m.ganancia_operacion}\n`; });
        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Reporte_Gomeria.csv";
        link.click();
    }

    window.onload = () => { cargarStock(); cargarMovimientos('hoy'); };
</script>
</body>
</html>
