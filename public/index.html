<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gomer√≠a - Admin Due√±o</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: url('fondo_admin.jpg') no-repeat center center fixed; 
            background-size: cover;
            padding: 10px; margin: 0; color: #333;
        }
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4); z-index: -1;
        }
        .container { max-width: 1200px; margin: auto; }
        .card { 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); 
            padding: 15px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); 
            margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.3);
        }
        h2 { color: #2c3e50; margin-top: 0; border-left: 5px solid #007bff; padding-left: 10px; }
        input, select { padding: 10px; margin: 5px; border-radius: 6px; border: 1px solid #ccc; width: 180px; }
        .btn-guardar { background: #007bff; color: white; padding: 10px 25px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-guardar:hover { background: #0056b3; transform: scale(1.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 8px; overflow: hidden; }
        th { background: #007bff; color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        .badge-stock { padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.85em; }
        .stock-bajo { background: #ffebee; color: #c62828; }
        .stock-ok { background: #e8f5e9; color: #2e7d32; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2 id="tituloForm">üì• Registro de Mercader√≠a</h2>
        <form id="formProducto">
            <input type="text" id="nombre" placeholder="Nombre del Art√≠culo" required>
            <select id="categoria">
                <option value="Parches">Parches</option>
                <option value="C√°maras">C√°maras</option>
                <option value="Cubiertas">Cubiertas</option>
                <option value="Protectores">Protectores</option>
                <option value="V√°lvulas">V√°lvulas</option>
                <option value="Accesorios">Accesorios</option>
                <option value="Servicio">Servicio</option>
            </select>
            <input type="number" id="precio_costo" placeholder="Costo ($)" required>
            <input type="number" id="precio_venta" placeholder="Venta ($)" required>
            <input type="number" id="stock_actual" placeholder="Stock Inicial" required>
            <button type="submit" class="btn-guardar">GUARDAR / SUMAR</button>
        </form>
    </div>

    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div class="card" style="flex: 2; min-width: 600px;">
            <h2>üìä Inventario y Movimientos</h2>
            <div style="margin-bottom: 15px;">
                <input type="text" id="buscador" placeholder="üîç Buscar por nombre..." onkeyup="buscar()" style="width: 100%;">
            </div>
            <table>
                <thead>
                    <tr><th>Art√≠culo</th><th>Categor√≠a</th><th>Venta</th><th>Stock</th><th>Acci√≥n</th></tr>
                </thead>
                <tbody id="tablaCuerpo"></tbody>
            </table>
        </div>

        <div class="card" style="flex: 1; min-width: 300px; text-align: center;">
            <h2>üí∞ Ganancia Real</h2>
            <canvas id="graficoDonut"></canvas>
            <div id="leyendaGrafico" style="margin-top: 15px; font-weight: bold; font-size: 1.1em;"></div>
        </div>
    </div>

    <div class="card">
        <h2>üóìÔ∏è Historial Completo</h2>
        <div style="margin-bottom: 10px;">
            <input type="date" id="fechaFiltro">
            <button onclick="filtrarPorFecha()" class="btn-guardar" style="background: #28a745;">Filtrar</button>
            <button onclick="descargarExcel()" class="btn-guardar" style="background: #6c757d;">Descargar Excel</button>
        </div>
        <table id="tablaMovs">
            <thead>
                <tr><th>Fecha</th><th>Descripci√≥n</th><th>Monto</th><th>Ganancia</th></tr>
            </thead>
            <tbody id="cuerpoMovs"></tbody>
        </table>
    </div>
</div>

<script>
    let miGrafico;
    let productosRaw = [];
    let movimientosActuales = [];
    let editandoId = null;

    async function cargarDatos() {
        try {
            const [resP, resM] = await Promise.all([
                fetch('/productos'),
                fetch('/movimientos/todo')
            ]);
            
            productosRaw = await resP.json();
            movimientosActuales = await resM.json();

            renderizarProductos();
            renderizarMovimientos(movimientosActuales);
            procesarGrafico(movimientosActuales);
        } catch (e) { console.error("Error al cargar", e); }
    }

    function renderizarProductos() {
        const tbody = document.getElementById('tablaCuerpo');
        tbody.innerHTML = '';
        productosRaw.forEach(p => {
            const claseStock = p.stock_actual <= 5 ? 'stock-bajo' : 'stock-ok';
            const stockTxt = p.categoria === 'Servicio' ? '‚àû' : p.stock_actual;
            tbody.innerHTML += `
                <tr>
                    <td><strong>${p.nombre}</strong></td>
                    <td>${p.categoria}</td>
                    <td>$${p.precio_venta}</td>
                    <td><span class="badge-stock ${claseStock}">${stockTxt}</span></td>
                    <td><button onclick='prepararEdicion(${JSON.stringify(p)})' style="background:none;border:none;cursor:pointer;">‚úèÔ∏è</button></td>
                </tr>`;
        });
    }

    function renderizarMovimientos(lista) {
        const tbody = document.getElementById('cuerpoMovs');
        tbody.innerHTML = '';
        lista.forEach(m => {
            const fecha = new Date(m.fecha).toLocaleString();
            tbody.innerHTML += `<tr><td>${fecha}</td><td>${m.descripcion}</td><td>$${m.monto_operacion}</td><td>$${m.ganancia_operacion}</td></tr>`;
        });
    }

    function procesarGrafico(movs) {
        let prod = 0, serv = 0;
        movs.forEach(m => {
            // Buscamos la categor√≠a en la descripci√≥n (el servidor ahora la enviar√° as√≠)
            if (m.descripcion.toLowerCase().includes('servicio')) {
                serv += parseFloat(m.ganancia_operacion);
            } else {
                prod += parseFloat(m.ganancia_operacion);
            }
        });

        const ctx = document.getElementById('graficoDonut').getContext('2d');
        if (miGrafico) miGrafico.destroy();
        miGrafico = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Productos', 'Servicios'],
                datasets: [{
                    data: [prod, serv],
                    backgroundColor: ['#007bff', '#28a745'],
                    borderWidth: 0
                }]
            },
            options: { plugins: { legend: { position: 'bottom' } } }
        });
        document.getElementById('leyendaGrafico').innerHTML = `Total: $${(prod + serv).toFixed(0)}`;
    }

    document.getElementById('formProducto').onsubmit = async (e) => {
        e.preventDefault();
        const data = {
            id_producto: editandoId,
            nombre: document.getElementById('nombre').value,
            categoria: document.getElementById('categoria').value,
            precio_costo: parseFloat(document.getElementById('precio_costo').value),
            precio_venta: parseFloat(document.getElementById('precio_venta').value),
            stock_actual: parseInt(document.getElementById('stock_actual').value)
        };

        const res = await fetch('/productos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (res.ok) {
            alert("‚úÖ Guardado correctamente");
            location.reload();
        }
    };

    function prepararEdicion(p) {
        editandoId = p.id_producto;
        document.getElementById('nombre').value = p.nombre;
        document.getElementById('categoria').value = p.categoria;
        document.getElementById('precio_costo').value = p.precio_costo;
        document.getElementById('precio_venta').value = p.precio_venta;
        document.getElementById('stock_actual').value = p.stock_actual;
        document.getElementById('tituloForm').innerText = "‚úèÔ∏è Editando: " + p.nombre;
        window.scrollTo(0,0);
    }

    function buscar() {
        const b = document.getElementById('buscador').value.toLowerCase();
        const filas = document.getElementById('tablaCuerpo').getElementsByTagName('tr');
        for (let f of filas) { f.style.display = f.innerText.toLowerCase().includes(b) ? '' : 'none'; }
    }

    function filtrarPorFecha() {
        const f = document.getElementById('fechaFiltro').value;
        if (!f) return;
        const filtrados = movimientosActuales.filter(m => m.fecha.startsWith(f));
        renderizarMovimientos(filtrados);
        procesarGrafico(filtrados);
    }

    function descargarExcel() {
        let csv = "Fecha;Descripcion;Monto;Ganancia\n";
        movimientosActuales.forEach(m => { 
            csv += `${new Date(m.fecha).toLocaleString()};${m.descripcion};${m.monto_operacion};${m.ganancia_operacion}\n`; 
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Reporte_Gomeria.csv";
        link.click();
    }

    window.onload = cargarDatos;
</script>
</body>
</html>
